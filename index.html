<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portofolio Kreatif Saya</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        body { background-color: #020617; }
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ========================================== -->
    <!-- ðŸ”’ FILE KEAMANAN EKSTERNAL ðŸ”’              -->
    <!-- ========================================== -->
    <script src="./auth.js"></script>

    <!-- Script Utama Aplikasi -->
<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { 
    Edit, Save, Plus, Trash2, ExternalLink, Youtube, Image as ImageIcon, 
    X, Check, Mail, Phone, Briefcase, GraduationCap, Cpu, 
    Lock, Unlock, MapPin, Video, Palette, Camera, ArrowLeft, LogOut, Code, Github, Upload
} from 'lucide-react';

/* --------------------------
   Helpers
   -------------------------- */
const getVideoInfo = (url) => {
    if (!url) return { type: null, id: null };
    const ytMatch = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/);
    if (ytMatch && ytMatch[2].length === 11) return { type: 'youtube', id: ytMatch[2] };
    const ttMatch = url.match(/tiktok\.com\/@.+\/video\/(\d+)/);
    if (ttMatch && ttMatch[1]) return { type: 'tiktok', id: ttMatch[1] };
    return { type: null, id: null };
};

function utf8_to_b64(str) {
    return window.btoa(unescape(encodeURIComponent(str)));
}
function b64_to_utf8(str) {
    return decodeURIComponent(escape(window.atob(str)));
}

/* --------------------------
   Reusable: Upload to GitHub
   (GET -> replace marker -> PUT)
   -------------------------- */
async function uploadToGitHub(creds, data, onProgress = () => {}) {
    if (!creds || !creds.username || !creds.repo || !creds.token) {
        throw new Error("GitHub credentials incomplete.");
    }
    const filePath = 'index.html';
    const apiUrlGet = `https://api.github.com/repos/${creds.username}/${creds.repo}/contents/${filePath}?ref=${creds.branch || 'main'}`;
    onProgress("Mengambil file dari GitHub...");
    const getRes = await fetch(apiUrlGet + `&t=${new Date().getTime()}`, {
        headers: {
            'Authorization': `token ${creds.token}`,
            'Accept': 'application/vnd.github.v3+json'
        },
        cache: 'no-store'
    });

    if (!getRes.ok) {
        if (getRes.status === 404) throw new Error("File index.html tidak ditemukan di repository.");
        if ([401,403].includes(getRes.status)) throw new Error("Token GitHub salah atau tidak memiliki izin.");
        throw new Error(`Gagal mengambil file (${getRes.status}).`);
    }

    const fileData = await getRes.json();
    const currentSha = fileData.sha;
    // keep original formatting as much as possible
    const currentContent = b64_to_utf8(fileData.content.replace(/\r\n/g, '\n'));

    onProgress("Memproses data untuk disisipkan...");
    const newDataString = `
        // MARKER_START
        const defaultProfile = ${JSON.stringify(data.profile, null, 4)};

        const defaultProjects = ${JSON.stringify(data.projects, null, 4)};

        const defaultExperience = ${JSON.stringify(data.experience, null, 4)};

        const defaultEducation = ${JSON.stringify(data.education, null, 4)};

        const defaultSkills = ${JSON.stringify(data.skills, null, 4)};
        // MARKER_END
    `;

    // Flexible regex: find comment markers and replace between them
    const regex = /(\/\/\s*MARKER_START)[\s\S]*?(\/\/\s*MARKER_END)/;
    if (!regex.test(currentContent)) {
        throw new Error("Gagal menemukan marker di file GitHub. Pastikan // MARKER_START dan // MARKER_END ada.");
    }

    const newFileContent = currentContent.replace(regex, `$1\n${newDataString}\n$2`);
    const encodedContent = utf8_to_b64(newFileContent);

    onProgress("Mengupload perubahan ke GitHub...");
    const putRes = await fetch(`https://api.github.com/repos/${creds.username}/${creds.repo}/contents/${filePath}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${creds.token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
            message: `Update portofolio otomatis (${new Date().toLocaleString()})`,
            content: encodedContent,
            sha: currentSha,
            branch: creds.branch || 'main'
        })
    });

    if (!putRes.ok) {
        const errInfo = await putRes.json().catch(()=>({message:'Unknown'}));
        throw new Error("Gagal upload: " + (errInfo.message || "Unknown error"));
    }

    return await putRes.json();
}

/* --------------------------
   Initial Data (ke dalam file: tetap pakai MARKER)
   -------------------------- */
// MARKER_START
const defaultProfile = {
    "name": "Muhammad Azis Faturrohman",
    "title": "Videografer, Desain Grafis, Photografer",
    "bio": "saya adalah",
    "avatar": "https://cdn.discordapp.com/attachments/1016033496210358422/1444720372745371850/IMG_6824.JPG?ex=692dbc32&is=692c6ab2&hm=3b0d9d7afcbdcc8e597e59ec01bd2c8ddbdf60aaef88499374384a62302410d5&",
    "email": "work@alexcreator.com",
    "phone": "+62 812 3456 7890",
    "location": "Jakarta, Indonesia"
};

const defaultProjects = [
    {
        "id": 1,
        "category": "design",
        "title": "Brand Identity: Kopi Senja",
        "description": "Desain logo dan packaging untuk startup kopi lokal dengan nuansa modern minimalis.",
        "image": "https://images.unsplash.com/photo-1600607686527-6fb886090705?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        "type": "image",
        "link": "#"
    },
    {
        "id": 2,
        "category": "videography",
        "title": "Cinematic Travel Vlog",
        "description": "Dokumentasi perjalanan wisata Bali dengan color grading sinematik.",
        "videoUrl": "https://www.youtube.com/watch?v=LXb3EKWsInQ",
        "type": "video",
        "link": "#"
    },
    {
        "id": 3,
        "category": "photography",
        "title": "Urban Street Photography",
        "description": "Koleksi foto jalanan Jakarta di malam hari dengan teknik long exposure.",
        "image": "https://images.unsplash.com/photo-1517789729358-1936c8882046?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        "type": "image",
        "link": "#"
    }
];

const defaultExperience = [
    {
        "id": 1,
        "role": "Senior Visual Designer",
        "company": "Creative Studio Ind",
        "period": "2022 - Sekarang",
        "description": "Bertanggung jawab atas art direction untuk klien korporat dan manajemen tim kreatif."
    },
    {
        "id": 2,
        "role": "Freelance Photographer",
        "company": "Self Employed",
        "period": "2019 - 2022",
        "description": "Mengerjakan proyek fotografi komersial, pernikahan, dan event dokumentasi."
    }
];

const defaultEducation = [
    {
        "id": 1,
        "degree": "S1 Desain Komunikasi Visual",
        "school": "Institut Kesenian Jakarta",
        "period": "2015 - 2019",
        "description": "Fokus pada multimedia dan fotografi digital."
    }
];

const defaultSkills = [
    "Adobe Premiere",
    "Photoshop",
    "Lightroom",
    "Figma",
    "React JS",
    "Cinematography"
];
// MARKER_END

/* --------------------------
   GitHub Modal: sekarang memanggil uploadToGitHub()
   -------------------------- */
function GitHubModal({ isOpen, onClose, data }) {
    const [step, setStep] = useState(1); // 1: Form, 2: Loading, 3: Success, 4: Error
    const [creds, setCreds] = useState({ username: '', repo: '', token: '', branch: 'main' });
    const [statusMsg, setStatusMsg] = useState('');

    useEffect(() => {
        const savedCreds = localStorage.getItem('gh_creds');
        if (savedCreds) setCreds(JSON.parse(savedCreds));
    }, []);

    if (!isOpen) return null;

    const handleSave = async () => {
        setStep(2);
        setStatusMsg("Menyiapkan upload...");
        localStorage.setItem('gh_creds', JSON.stringify(creds));

        try {
            if(!creds.username || !creds.repo || !creds.token) {
                throw new Error("Data GitHub belum lengkap.");
            }
            await uploadToGitHub(creds, data, (m)=>setStatusMsg(m));
            setStep(3);
        } catch (error) {
            console.error(error);
            setStatusMsg(error.message || 'Unknown error');
            setStep(4);
        }
    };

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
                {step === 1 && (
                    <>
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <Github size={24}/> Simpan ke GitHub
                        </h3>
                        <p className="text-sm text-slate-400 mb-4">
                            Masukkan detail repository Anda untuk menyimpan perubahan secara permanen.
                        </p>
                        <div className="space-y-3">
                            <input placeholder="GitHub Username" value={creds.username} onChange={e=>setCreds({...creds, username:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white"/>
                            <input placeholder="Repository Name (contoh: portofolio-saya)" value={creds.repo} onChange={e=>setCreds({...creds, repo:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white"/>
                            <input placeholder="Branch (default: main)" value={creds.branch} onChange={e=>setCreds({...creds, branch:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white"/>
                            <div>
                                <input type="password" placeholder="Personal Access Token (Repo Scope)" value={creds.token} onChange={e=>setCreds({...creds, token:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white"/>
                                <a href="https://github.com/settings/tokens" target="_blank" rel="noreferrer" className="text-xs text-blue-400 hover:underline block mt-1">Buat token di sini (Pilih 'Classic', centang 'repo')</a>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-300 hover:bg-slate-800 rounded">Batal</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded font-bold">Upload</button>
                        </div>
                    </>
                )}

                {step === 2 && (
                    <div className="text-center py-8">
                        <div className="loader mx-auto mb-4"></div>
                        <p className="text-white animate-pulse">{statusMsg}</p>
                    </div>
                )}

                {step === 3 && (
                    <div className="text-center py-8">
                        <Check size={32} className="mx-auto text-green-400 mb-4"/>
                        <p className="text-white">Berhasil disimpan ke GitHub.</p>
                        <div className="mt-6">
                            <button onClick={() => { setStep(1); onClose(); }} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded">Tutup</button>
                        </div>
                    </div>
                )}

                {step === 4 && (
                    <div className="text-center py-8">
                        <p className="text-red-400 mb-4">Gagal: {statusMsg}</p>
                        <div className="mt-6">
                            <button onClick={() => setStep(1)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">Kembali</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

/* --------------------------
   Main App
   -------------------------- */
function App() {
    const [profile, setProfile] = useState(defaultProfile);
    const [projects, setProjects] = useState(defaultProjects);
    const [experience, setExperience] = useState(defaultExperience);
    const [education, setEducation] = useState(defaultEducation);
    const [skills, setSkills] = useState(defaultSkills);

    const [isAuthenticated, setIsAuthenticated] = useState(!!window?.isAdmin);
    const [isEditing, setIsEditing] = useState(false);
    const [showGitHubModal, setShowGitHubModal] = useState(false);

    // Auto-sync states
    const [autoSync, setAutoSync] = useState(() => {
        try { return JSON.parse(localStorage.getItem('pf_auto_sync') || 'false'); } catch(e){return false;}
    });
    const isUploadingRef = useRef(false);
    const syncTimerRef = useRef(null);
    const lastPayloadRef = useRef(null);
    const [syncStatus, setSyncStatus] = useState('');
    const [activeCategory, setActiveCategory] = useState('');

    useEffect(() => {
        // set isAuthenticated based on injected auth helper if available
        if (window && typeof window?.isAdmin !== 'undefined') setIsAuthenticated(!!window.isAdmin);
    }, []);

    // Debounced auto-sync effect
    useEffect(() => {
        // Only run when autoSync enabled and user authenticated
        if (!autoSync || !isAuthenticated) return;

        const payload = { profile, projects, experience, education, skills };
        const payloadStr = JSON.stringify(payload);

        if (lastPayloadRef.current === payloadStr) return;

        if (syncTimerRef.current) clearTimeout(syncTimerRef.current);
        syncTimerRef.current = setTimeout(async () => {
            if (isUploadingRef.current) return;

            const saved = localStorage.getItem('gh_creds');
            if (!saved) {
                console.warn("AutoSync: GH creds not found. Skipping.");
                setSyncStatus('AutoSync: GitHub creds tidak ditemukan.');
                return;
            }
            const creds = JSON.parse(saved);
            if (!creds.username || !creds.repo || !creds.token) {
                console.warn("AutoSync: incomplete GH creds. Skipping.");
                setSyncStatus('AutoSync: Kredensial GitHub tidak lengkap.');
                return;
            }

            try {
                isUploadingRef.current = true;
                setSyncStatus('AutoSync: Mengupload...');
                await uploadToGitHub(creds, payload, (m)=>setSyncStatus('AutoSync: ' + m));
                lastPayloadRef.current = payloadStr;
                setSyncStatus('Terakhir disinkronkan: ' + new Date().toLocaleTimeString());
            } catch (err) {
                console.error("AutoSync error:", err);
                setSyncStatus('AutoSync error: ' + (err.message || 'Unknown'));
            } finally {
                isUploadingRef.current = false;
                syncTimerRef.current = null;
            }
        }, 3000);

        return () => {
            if (syncTimerRef.current) clearTimeout(syncTimerRef.current);
        };
    }, [profile, projects, experience, education, skills, autoSync, isAuthenticated]);

    /* ---------- small helpers ---------- */
    const handleAuthAction = () => {
        if (isAuthenticated) {
            if (window?.doLogout) {
                window.doLogout();
                setIsAuthenticated(false);
                setIsEditing(false);
                alert("Berhasil Logout.");
            } else {
                setIsAuthenticated(false);
                alert("Logout (simulasi).");
            }
        } else {
            window.location.href = "login.html";
        }
    };

    const handleProfileChange = (e) => setProfile({ ...profile, [e.target.name]: e.target.value });

    const updateItem = (setter, list, id, field, value) => {
        setter(list.map(item => item.id === id ? { ...item, [field]: value } : item));
    };

    const deleteItem = (setter, list, id) => {
        if (confirm("Hapus item ini?")) setter(list.filter(item => item.id !== id));
    };

    const addItem = (setter, list, template) => setter([...list, { ...template, id: Date.now() }]);

    const addExperience = () => addItem(setExperience, experience, { role: "Peran Baru", company: "Perusahaan", period: "Tahun", description: "Deskripsi..." });
    const addEducation = () => addItem(setEducation, education, { degree: "Gelar", school: "Sekolah", period: "Tahun", description: "Deskripsi..." });

    const addProject = () => {
        if (!activeCategory) return;
        const defaultType = activeCategory === 'videography' ? 'video' : 'image';
        const defaultImage = activeCategory === 'videography' ? '' : 'https://via.placeholder.com/600x400';
        const newProj = { id: Date.now(), category: activeCategory, title: "Proyek Baru", description: "Deskripsi.", image: defaultImage, videoUrl: "", type: defaultType, link: "#" };
        setProjects([...projects, newProj]);
    };

    const addTag = (setter, list, input, setInput) => {
        if (input && input.trim()) { setter([...list, input.trim()]); setInput && setInput(""); }
    };
    const removeTag = (setter, list, index) => setter(list.filter((_, i) => i !== index));

    const categories = [
        { id: 'videography', label: 'Videografi', icon: Video, color: 'from-red-500 to-pink-600', desc: 'Video Youtube, Shorts, dan TikTok.' },
        { id: 'design', label: 'Desain Grafis', icon: Palette, color: 'from-purple-500 to-indigo-600', desc: 'Branding, UI/UX, dan ilustrasi digital.' },
        { id: 'photography', label: 'Fotografi', icon: Camera, color: 'from-green-400 to-emerald-600', desc: 'Potret, lanskap, dan fotografi jalanan.' }
    ];

    return (
        <div className="min-h-screen text-slate-100 font-sans selection:bg-cyan-500 selection:text-white pb-20">
            <GitHubModal isOpen={showGitHubModal} onClose={() => setShowGitHubModal(false)} data={{ profile, projects, experience, education, skills }} />

            <nav className="fixed top-0 w-full z-50 bg-slate-950/80 backdrop-blur-md border-b border-slate-800">
                <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <span className="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                        {profile.name}
                    </span>

                    <div className="flex items-center gap-4">
                        {isAuthenticated && (
                            <>
                                <label className="flex items-center gap-2 text-sm text-slate-300">
                                    <input type="checkbox" checked={autoSync} onChange={(e)=>{ setAutoSync(e.target.checked); localStorage.setItem('pf_auto_sync', JSON.stringify(e.target.checked)); }} />
                                    Auto-sync
                                </label>

                                <div className="flex gap-2">
                                    <button onClick={() => setShowGitHubModal(true)} className="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-slate-800 hover:bg-slate-700 text-white transition-all border border-slate-700">
                                        <Upload size={16} /> <span className="hidden sm:inline">Simpan ke GitHub</span>
                                    </button>

                                    <button onClick={() => setIsEditing(!isEditing)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all ${isEditing ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-slate-800 hover:bg-slate-700 text-slate-300'}`}>
                                        {isEditing ? <><Save size={16} /> Selesai</> : <><Edit size={16} /> Edit Mode</>}
                                    </button>
                                </div>
                            </>
                        )}

                        <button onClick={handleAuthAction} className={`flex items-center gap-2 px-3 py-1 rounded transition-colors ${isAuthenticated ? 'text-green-500 hover:bg-green-500/10' : 'text-slate-600 hover:text-slate-400'}`} title={isAuthenticated ? "Logout Admin" : "Login Admin"}>
                            {isAuthenticated ? <LogOut size={14} /> : <Lock size={14} />}
                            {isAuthenticated ? "Logout" : "Admin"}
                        </button>
                    </div>
                </div>
            </nav>

            {/* rest of UI (hero, sidebar, projects, etc.) */}
            {/* For brevity I keep the original UI code structure from your file here â€”
               This patch focuses on replacing internal script logic (helpers, upload, autosync).
               Keep the remainder of your original JSX markup as-is; below is a minimal footer + rendering */}
            <main className="pt-32 px-4">
                <div className="max-w-6xl mx-auto">
                    {/* (Your existing sections here â€” hero, projects, etc.) */}
                    {/* To keep this patch safe: the full JSX body remains unchanged from your original file. */}
                </div>
            </main>

            <footer className="max-w-6xl mx-auto px-4 mt-20 py-8 border-t border-slate-800 flex justify-between items-center text-slate-600 text-sm">
                <p>&copy; {new Date().getFullYear()} {profile.name}. All rights reserved.</p>
                <div className="flex flex-col items-end">
                    <div className="flex items-center gap-3">
                        <span className="text-xs text-slate-500">{syncStatus}</span>
                    </div>
                </div>
            </footer>
        </div>
    );
}

const root = createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>

