<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio - Auto Sync GitHub</title>

  <!-- Tailwind Play CDN (cepat untuk pengembangan) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel untuk menjalankan type="text/babel" di browser (hanya untuk dev/test) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* kecilkan loader */
    .loader {
      border: 4px solid rgba(255,255,255,0.06);
      border-top: 4px solid rgba(255,255,255,0.2);
      border-radius: 999px;
      width: 36px; height: 36px; animation: spin 1s linear infinite; margin:auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">

  <div id="root"></div>

  <!-- ---------- APP SCRIPT (paste/replace seluruh script lama) ---------- -->
  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /* --------------------------
     Helpers
     -------------------------- */
  function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
  function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

  /* --------------------------
     Reusable: Upload to GitHub
     GET -> replace marker -> PUT
     -------------------------- */
  async function uploadToGitHub(creds, data, onProgress = ()=>{}) {
    if (!creds || !creds.username || !creds.repo || !creds.token) {
      throw new Error("GitHub credentials incomplete.");
    }
    const filePath = 'index.html';
    const apiUrlGet = `https://api.github.com/repos/${creds.username}/${creds.repo}/contents/${filePath}?ref=${creds.branch || 'main'}`;
    onProgress("Mengambil index.html dari GitHub...");
    const getRes = await fetch(apiUrlGet + `&t=${Date.now()}`, {
      headers: {
        'Authorization': `token ${creds.token}`,
        'Accept': 'application/vnd.github.v3+json'
      },
      cache: 'no-store'
    });

    if (!getRes.ok) {
      if (getRes.status === 404) throw new Error("File index.html tidak ditemukan di repository.");
      if ([401,403].includes(getRes.status)) throw new Error("Token GitHub salah atau tidak memiliki izin.");
      throw new Error(`Gagal mengambil file (${getRes.status}).`);
    }

    const fileData = await getRes.json();
    const currentSha = fileData.sha;
    const currentContent = b64_to_utf8(fileData.content.replace(/\r\n/g, '\n'));

    onProgress("Menyusun data baru...");
    const newDataString = `
        // MARKER_START
        const defaultProfile = ${JSON.stringify(data.profile, null, 4)};

        const defaultProjects = ${JSON.stringify(data.projects, null, 4)};

        const defaultExperience = ${JSON.stringify(data.experience, null, 4)};

        const defaultEducation = ${JSON.stringify(data.education, null, 4)};

        const defaultSkills = ${JSON.stringify(data.skills, null, 4)};
        // MARKER_END
    `;

    const regex = /(\/\/\s*MARKER_START)[\s\S]*?(\/\/\s*MARKER_END)/;
    if (!regex.test(currentContent)) {
      throw new Error("Gagal menemukan marker // MARKER_START dan // MARKER_END di file GitHub.");
    }

    const newFileContent = currentContent.replace(regex, `$1\n${newDataString}\n$2`);
    const encodedContent = utf8_to_b64(newFileContent);

    onProgress("Mengupload perubahan ke GitHub...");
    const putRes = await fetch(`https://api.github.com/repos/${creds.username}/${creds.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${creds.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({
        message: `Auto-update portfolio: ${new Date().toLocaleString()}`,
        content: encodedContent,
        sha: currentSha,
        branch: creds.branch || 'main'
      })
    });

    if (!putRes.ok) {
      const errInfo = await putRes.json().catch(()=>({message:'Unknown'}));
      throw new Error("Gagal upload: " + (errInfo.message || "Unknown error"));
    }

    return await putRes.json();
  }

  /* --------------------------
     --- Default data (THIS IS THE MARKER BLOCK INSIDE index.html)
     --------------------------
     Note: This exact marker block also exists in this same file (so uploads will replace it).
  */
  // MARKER_START
  const defaultProfile = {
    "name": "Muhammad Azis Faturrohman",
    "title": "Videografer & Desainer",
    "bio": "Pembuat konten visual dan desainer kreatif.",
    "avatar": "",
    "email": "work@example.com",
    "phone": "+62 812 3456 7890",
    "location": "Jakarta, Indonesia"
  };

  const defaultProjects = [
    { "id": 1, "category": "design", "title": "Brand Kopi Senja", "description": "Identitas visual & packaging", "image": "", "type":"image", "link":"#" },
    { "id": 2, "category": "videography", "title": "Travel Vlog", "description": "Cinematic travel vlog", "videoUrl": "", "type":"video", "link":"#" }
  ];

  const defaultExperience = [
    { "id":1, "role":"Senior Visual Designer", "company":"Creative Studio", "period":"2022 - Sekarang", "description":"Art direction & team lead." }
  ];

  const defaultEducation = [
    { "id":1, "degree":"S1 DKV", "school":"Institut Seni", "period":"2015-2019", "description":"Konsentrasi multimedia." }
  ];

  const defaultSkills = ["Adobe Premiere","Photoshop","Lightroom","Figma"];
  // MARKER_END

  /* --------------------------
     GitHub Modal Component
     -------------------------- */
  function GitHubModal({open, onClose, data}) {
    const [step, setStep] = useState(1);
    const [creds, setCreds] = useState(()=> {
      const s = localStorage.getItem('gh_creds');
      return s ? JSON.parse(s) : { username:'', repo:'', token:'', branch:'main' };
    });
    const [status, setStatus] = useState('');

    useEffect(()=> {
      const s = localStorage.getItem('gh_creds');
      if (s) setCreds(JSON.parse(s));
    },[]);

    if (!open) return null;

    const handleSave = async () => {
      setStep(2); setStatus('Memulai upload...');
      localStorage.setItem('gh_creds', JSON.stringify(creds));
      try {
        await uploadToGitHub(creds, data, (m)=>setStatus(m));
        setStep(3);
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Upload error');
        setStep(4);
      }
    };

    return (
      <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/70 p-4">
        <div className="w-full max-w-md bg-slate-800 rounded-lg p-5 border border-slate-700">
          {step===1 && (
            <>
              <h3 className="text-lg font-semibold mb-2">Simpan ke GitHub</h3>
              <p className="text-sm text-slate-300 mb-3">Masukkan username, repo, branch, dan personal access token (repo scope).</p>

              <input className="w-full mb-2 p-2 rounded bg-slate-700" placeholder="GitHub Username" value={creds.username} onChange={e=>setCreds({...creds, username:e.target.value})} />
              <input className="w-full mb-2 p-2 rounded bg-slate-700" placeholder="Repository (contoh: my-portfolio)" value={creds.repo} onChange={e=>setCreds({...creds, repo:e.target.value})} />
              <input className="w-full mb-2 p-2 rounded bg-slate-700" placeholder="Branch (default: main)" value={creds.branch} onChange={e=>setCreds({...creds, branch:e.target.value})} />
              <input className="w-full mb-2 p-2 rounded bg-slate-700" placeholder="Personal Access Token" value={creds.token} onChange={e=>setCreds({...creds, token:e.target.value})} />

              <div className="flex justify-end gap-2 mt-3">
                <button onClick={onClose} className="px-3 py-1 rounded bg-slate-700">Batal</button>
                <button onClick={handleSave} className="px-3 py-1 rounded bg-cyan-600">Upload</button>
              </div>
            </>
          )}

          {step===2 && (
            <div className="text-center py-6">
              <div className="loader mb-3"></div>
              <div className="text-sm text-slate-200">{status}</div>
            </div>
          )}

          {step===3 && (
            <div className="text-center py-6">
              <div className="text-green-400 font-semibold mb-2">Berhasil!</div>
              <div className="text-sm text-slate-300 mb-4">Perubahan berhasil di-push ke GitHub.</div>
              <div className="flex justify-center">
                <button onClick={()=>{ setStep(1); onClose(); }} className="px-3 py-1 rounded bg-cyan-600">Tutup</button>
              </div>
            </div>
          )}

          {step===4 && (
            <div className="text-center py-6">
              <div className="text-red-400 font-semibold mb-2">Gagal</div>
              <div className="text-sm text-slate-300 mb-4">{status}</div>
              <div className="flex justify-center">
                <button onClick={()=>setStep(1)} className="px-3 py-1 rounded bg-slate-700">Kembali</button>
              </div>
            </div>
          )}

        </div>
      </div>
    );
  }

  /* --------------------------
     Main App
     -------------------------- */
  function App(){
    const [profile, setProfile] = useState(defaultProfile);
    const [projects, setProjects] = useState(defaultProjects);
    const [experience, setExperience] = useState(defaultExperience);
    const [education, setEducation] = useState(defaultEducation);
    const [skills, setSkills] = useState(defaultSkills);

    const [isEditing, setIsEditing] = useState(false);
    const [showModal, setShowModal] = useState(false);
    const [autoSync, setAutoSync] = useState(()=> {
      try { return JSON.parse(localStorage.getItem('pf_auto_sync') || 'false'); } catch(e){ return false; }
    });
    const [syncStatus, setSyncStatus] = useState('');
    const syncTimerRef = useRef(null);
    const isUploadingRef = useRef(false);
    const lastPayloadRef = useRef(null);

    // when data changes and autoSync enabled -> debounce upload
    useEffect(()=> {
      if (!autoSync) return;
      const payload = { profile, projects, experience, education, skills };
      const payloadStr = JSON.stringify(payload);
      if (lastPayloadRef.current === payloadStr) return;

      if (syncTimerRef.current) clearTimeout(syncTimerRef.current);
      syncTimerRef.current = setTimeout(async ()=>{
        if (isUploadingRef.current) return;
        const saved = localStorage.getItem('gh_creds');
        if (!saved) { setSyncStatus('AutoSync: kredensial GitHub kosong.'); return; }
        const creds = JSON.parse(saved);
        if (!creds.username || !creds.repo || !creds.token) { setSyncStatus('AutoSync: kredensial tidak lengkap.'); return; }

        try {
          isUploadingRef.current = true;
          setSyncStatus('AutoSync: mengupload...');
          await uploadToGitHub(creds, payload, (m)=>setSyncStatus('AutoSync: ' + m));
          lastPayloadRef.current = payloadStr;
          setSyncStatus('Terakhir sinkron: ' + new Date().toLocaleTimeString());
        } catch (err) {
          console.error(err);
          setSyncStatus('AutoSync error: ' + (err.message||'Unknown'));
        } finally {
          isUploadingRef.current = false;
          syncTimerRef.current = null;
        }
      }, 3000);

      return ()=> { if (syncTimerRef.current) clearTimeout(syncTimerRef.current); };
    }, [profile, projects, experience, education, skills, autoSync]);

    const toggleAutoSync = (v) => {
      setAutoSync(v);
      localStorage.setItem('pf_auto_sync', JSON.stringify(v));
    };

    // simple UI handlers
    const updateProfileField = (k,v) => setProfile(prev=>({ ...prev, [k]: v }));

    // small add/remove helpers for lists:
    const addProject = ()=> setProjects(prev=>[...prev, { id: Date.now(), category:'design', title:'Proyek Baru', description:'', image:'', type:'image', link:'#' }]);
    const removeProject = (id)=> setProjects(prev=>prev.filter(p=>p.id!==id));
    const updateProject = (id, field, val)=> setProjects(prev=>prev.map(p=> p.id===id ? {...p, [field]: val} : p));

    return (
      <div className="min-h-screen pb-20">
        {/* NAV */}
        <nav className="bg-slate-800 border-b border-slate-700 fixed w-full z-30">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div>
              <span className="font-bold text-cyan-300">Portfolio</span>
              <span className="ml-2 text-slate-300 text-sm">{profile.name}</span>
            </div>
            <div className="flex items-center gap-3">
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={autoSync} onChange={(e)=>toggleAutoSync(e.target.checked)} />
                <span className="text-slate-300">Auto-sync</span>
              </label>

              <button onClick={()=>setShowModal(true)} className="px-3 py-1 bg-cyan-600 rounded text-sm">Simpan ke GitHub</button>
              <button onClick={()=>setIsEditing(s=>!s)} className={`px-3 py-1 rounded text-sm ${isEditing ? 'bg-green-600' : 'bg-slate-700'}`}>{isEditing ? 'Selesai' : 'Edit'}</button>
            </div>
          </div>
        </nav>

        <main className="pt-20 max-w-6xl mx-auto px-4">
          <section className="bg-slate-800 rounded-lg p-6 border border-slate-700">
            <div className="flex gap-6">
              <div className="w-28 h-28 bg-slate-700 rounded flex items-center justify-center text-slate-400">
                { profile.avatar ? <img src={profile.avatar} alt="avatar" className="w-full h-full object-cover rounded" /> : <span>Avatar</span> }
              </div>

              <div className="flex-1">
                {isEditing ? (
                  <>
                    <input className="w-full p-2 mb-2 rounded bg-slate-700" value={profile.name} onChange={(e)=>updateProfileField('name', e.target.value)} />
                    <input className="w-full p-2 mb-2 rounded bg-slate-700" value={profile.title} onChange={(e)=>updateProfileField('title', e.target.value)} />
                    <textarea className="w-full p-2 mb-2 rounded bg-slate-700" value={profile.bio} onChange={(e)=>updateProfileField('bio', e.target.value)} />
                  </>
                ) : (
                  <>
                    <h1 className="text-2xl font-bold">{profile.name}</h1>
                    <div className="text-slate-300">{profile.title}</div>
                    <p className="mt-2 text-slate-400">{profile.bio}</p>
                  </>
                )}
              </div>
            </div>
          </section>

          <section className="mt-6 grid md:grid-cols-2 gap-4">
            <div className="bg-slate-800 p-4 rounded border border-slate-700">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-semibold">Projects</h3>
                <div className="flex items-center gap-2">
                  <button onClick={addProject} className="px-2 py-1 bg-slate-700 rounded text-sm">+ Add</button>
                </div>
              </div>

              <div className="space-y-3">
                {projects.map(proj=>(
                  <div key={proj.id} className="p-3 rounded bg-slate-900 border border-slate-800">
                    {isEditing ? (
                      <>
                        <input className="w-full mb-1 p-1 rounded bg-slate-800" value={proj.title} onChange={(e)=>updateProject(proj.id,'title', e.target.value)} />
                        <input className="w-full mb-1 p-1 rounded bg-slate-800" value={proj.description} onChange={(e)=>updateProject(proj.id,'description', e.target.value)} />
                        <div className="flex justify-between mt-2">
                          <button onClick={()=>removeProject(proj.id)} className="px-2 py-1 rounded bg-red-600 text-sm">Hapus</button>
                        </div>
                      </>
                    ) : (
                      <>
                        <div className="font-semibold">{proj.title}</div>
                        <div className="text-slate-400 text-sm">{proj.description}</div>
                      </>
                    )}
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-slate-800 p-4 rounded border border-slate-700">
              <h3 className="font-semibold mb-2">Skills</h3>
              {isEditing ? (
                <textarea className="w-full p-2 bg-slate-800 rounded" value={skills.join(", ")} onChange={(e)=>setSkills(e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} />
              ) : (
                <div className="flex flex-wrap gap-2">
                  {skills.map((s,i)=>(<span key={i} className="px-2 py-1 bg-slate-700 rounded text-sm">{s}</span>))}
                </div>
              )}
            </div>
          </section>

          <div className="mt-6 text-sm text-slate-400">
            <strong>{syncStatus}</strong>
          </div>
        </main>

        <footer className="max-w-6xl mx-auto px-4 mt-12 py-6 text-xs text-slate-500">
          &copy; {new Date().getFullYear()} - Auto Sync Demo
        </footer>

        <GitHubModal open={showModal} onClose={()=>setShowModal(false)} data={{ profile, projects, experience, education, skills }} />
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  <!-- ---------- END APP SCRIPT ---------- -->

</body>
</html>
